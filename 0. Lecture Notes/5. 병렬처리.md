# 병렬 처리

## 병렬 처리 개요

여러 기능을 동시에 구현·테스트해야 할 때 사용할 수 있는 병렬 처리 방식은 크게 세 가지

- **조인 병렬**: 구현은 병렬로 진행하되, 최종 통합(통합 테스트, 빌드 & 커밋)은 한 번에 모아서 실행
- **독립 병렬**: 기능(작업) 단위로 Git 작업 공간과 커밋을 완전히 분리
- **완전 자동화**: 백그라운드 에이전트·슬랙 등을 이용해 전체 흐름을 자동화

<br/>

## 1. 조인 병렬

### 1-1. 개념

- 커서 채팅창에서 **여러 개의 채팅(작업)** 을 열고, 각 채팅마다 서로 다른 기능을 **병렬로 구현**
- 현재 Rules 기준, 한 기능에 대한 기본 작업 순서는 다음과 같음
  - 구현
  - 룰 재검토
  - 코드 스타일 재검토
  - 단위 테스트
  - 통합 테스트
  - 빌드 & 커밋

문제는, **각 기능마다 위 과정을 끝까지 전부 돌리면** 마지막 단계에서 충돌이 생길 수 있음

- 예시
  - 기능 1: 구현 완료 → 통합 테스트 실행 중
  - 기능 2: 아직 구현 진행 중
  - 이 상태에서 통합 테스트를 실행하면, 구현이 덜 된 기능 때문에 테스트가 실패하고, 빌드 & 커밋도 진행하기 어려움

따라서 조인 병렬에서는 다음과 같이 정리해서 사용

- 각 기능(채팅)은 **단위 테스트까지만** 진행
- 모든 기능이 **단위 테스트까지 통과한 시점**에,
  - 한 번만 **통합 테스트**를 실행하고
  - 한 번만 **빌드 & 커밋**을 실행

→ 구현·단위 테스트는 **각 기능별로 병렬**로 진행하고,  
→ 통합 테스트와 빌드 & 커밋은 **한 번으로 “조인(Join)”** 하기 때문에 **조인 병렬**이라고 부름

<br/>

### 1-2. Playwright 병렬 테스트와 포트 설정

조인 병렬을 실제로 활용하는 대표적인 예가 **Playwright E2E 테스트 병렬 실행**

- Playwright는 E2E 테스트 도구이기 때문에, 테스트마다 **브라우저 + 서버**가 필요
- 여러 테스트를 동시에 병렬로 실행하면, 서버 포트(예: `3000`)가 서로 충돌함
- 기본 설정은 보통 `http://localhost:3000`로 3000 포트 하나만 사용하도록 되어 있음

이를 해결하기 위해 Playwright의 **에이전트 인덱스(AGENT_INDEX)** 값을 활용

- 병렬 실행 시, Playwright는 각 워커(에이전트)에 대해 인덱스를 부여
- 이 인덱스를 이용해 포트를 다음과 같이 계산:
  - `기본 포트(3000) + 에이전트 인덱스`
  - 예시
    - 에이전트 0 → 포트 3000
    - 에이전트 1 → 포트 3001
    - 에이전트 2 → 포트 3002

#### AI 프롬프트 예시

`playwright.config.ts`에서 명령과 URL 설정을 바꾸고 싶을 때는, 아래와 같이 AI에게 요청

```text
@playwright.config.ts 의 command, url 설정을 변경해줘.
병렬 테스트를 위해서, agent-index(AGENT_INDEX 환경변수)를 포트 번호에 추가하는 방식으로 수정해줘.
```

#### 예시: `playwright.config.ts` 변경 전

```ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  use: {
    baseURL: 'http://localhost:3000',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],

  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
    env: {
      NEXT_PUBLIC_TEST_ENV: 'test',
    },
  },
});
```

#### 예시: `playwright.config.ts` 변경 후 (에이전트 인덱스로 포트 분리)

```ts
import { defineConfig, devices } from '@playwright/test';

// Playwright 병렬 에이전트 인덱스(환경 변수)로 고유 포트 계산
const agentIndex = Number(process.env.AGENT_INDEX ?? '0');
const port = 3000 + agentIndex;

export default defineConfig({
  use: {
    baseURL: `http://localhost:${port}`,
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],

  webServer: {
    command: `npm run dev -- -p ${port}`,
    url: `http://localhost:${port}`,
    reuseExistingServer: !process.env.CI,
    env: {
      NEXT_PUBLIC_TEST_ENV: 'test',
    },
  },
});
```

이렇게 설정하면 각 병렬 에이전트가 서로 다른 포트에서 서버를 띄우기 때문에, 포트 충돌 없이 조인 병렬 전략을 적용할 수 있음.

<br/>

## 2. 독립 병렬

### 2-1. 개념

조인 병렬은 “**통합 단계만 한 번에 모아서**” 처리하는 방식으로, 프로젝트가 커질수록 다음과 같은 문제가 생길 수 있음

- 여러 기능 구현이 **한 번의 커밋**으로 묶임
- 변경 범위가 넓어져서 **버전 관리·롤백이 어려움**

규모가 커지면 보통 **기능 하나당 커밋 하나**가 더 적절  
이를 위해 사용하는 방식이 **독립 병렬**

- 아이디어
  - 구현하는 것(기능 또는 UI) 하나당 **완전히 독립된 작업 공간**을 만듬
  - 하나의 Git 리포를 **여러 작업 디렉터리**로 나눠서 사용
  - 이때 사용하는 Git 기능이 **`git worktree`** 

정리하면 다음과 같음:
- 하나의 Git 프로젝트를
- `git worktree`로 여러 개의 작업 디렉터리로 분리하고
- 각 디렉터리를 커서에서 **서로 다른 프로젝트처럼 열어** 작업

### 2-2. 장단점

- 장점
  - 기능 단위로 **완전히 분리된 브랜치·작업 디렉터리**를 가질 수 있음.
  - 각 작업이 **자기만의 커밋**을 가지므로, 롤백·리뷰·배포 추적이 더 쉽움.
  - 조인 병렬에서 발생하는 “한 번에 너무 많은 변경을 묶는 커밋” 문제를 줄일 수 있음.

- 단점
  - `git worktree` 개념과 명령어를 **별도로 학습** 필요
  - 브랜치 전략과 작업 디렉터리 구조를 **미리 설계**해 두어야 함

<br/>

## 3. 완전 자동화

### 3-1. 개념

조인 병렬과 독립 병렬은 모두 **사람이 커서를 열고 명령을 실행**하는 흐름  
반대로, **완전 자동화**는 가능한 많은 단계를 **백그라운드에서 자동으로** 처리하도록 만드는 방식

- 백그라운드 에이전트
  - 클라우드 상에서 커서가 실행되며,
  - 에디터를 직접 열지 않아도 백그라운드에서 작업이 수행되는 형태

단순히 백그라운드 에이전트만 사용하는 것으로는,  
내가 사용하는 **recheck 시스템**, **알림 시스템**과 자연스럽게 연결하기가 어려움

그래서 보통 다음과 같이 구성

- 슬랙(Slack) 등 메신저와 연동
  - 특정 슬랙 채널에 명령/요청을 보냄
  - 백그라운드 에이전트가 이 요청을 받아 작업을 실행
  - 결과를 다시 슬랙 메시지로 전달

이러한 완전 자동화를 만들기 위해서는 다음 요소들이 필요

- 자동화 시스템 설계
- 매크로 / 워크플로우 정의
- Webhook, 슬랙 봇, CI 도구 등과의 연동

<br/>

## 정리

- **조인 병렬**: 구현·단위 테스트는 기능별로 병렬로 진행하고, **통합 테스트와 빌드 & 커밋은 한 번에 조인**해서 실행
- **독립 병렬**: `git worktree` 등을 활용해 기능 단위로 **작업 공간과 커밋을 완전히 분리**
- **완전 자동화**: 백그라운드 에이전트와 슬랙 등을 이용해 **사람 개입을 최소화한 자동 파이프라인**을 구성

프로젝트 규모와 복잡도에 따라, **조인 → 독립 → 완전 자동화** 순서로 점차 고도화하면서 병렬 처리 전략을 선택
